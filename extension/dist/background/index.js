(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a;}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r);},p,p.exports,r,e,n,t);}return n[i].exports;}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o;}return r;})()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class BashTemplate{constructor(templateUri){this.uri=templateUri;this.ok=false;this.error=null;this.bashTemplate='';}init(onInit){this.ok=false;fetch(this.uri).then(response=>{if(response.status!==200)throw new Error(`Response status code is ${response.status} (${this.uri})`);return response.text();}).then(bashTemplate=>{this.ok=true;this.error=null;this.bashTemplate=bashTemplate;if(typeof onInit==='function')setTimeout(onInit,0,bashTemplate);}).catch(error=>{this.ok=false;this.error=error;});}compile(context){if(!this.ok){if(this.error)throw this.error;throw new Error(`Request ${this.uri} not yet finished`);}return this.bashTemplate.replace(/\{\{\s+(\w+)\s+\}\}/g,replacer.bind(context));}matchString(regex,groupId=0){if(!this.ok)return'';if(!this.bashTemplate)return'';const matched=this.bashTemplate.match(regex);if(!matched)return'';return matched[groupId]||'';}}exports.BashTemplate=BashTemplate;function replacer(matched,varName){const value=String(this&&this[varName]||'');return value.replace(/'/g,"'\\''");}function noop(){}},{}],2:[function(require,module,exports){(function(global){"use strict";var _config=require("../config");var _mainPlayerPage=require("../inject/main-player-page");var _mainPlayerPageHls=require("../inject/main-player-page-hls");var _bashTemplate=require("./bash-template");var _messageSecurity=require("./message-security");var _uuid=require("./uuid");var _tabUtils=require("./tab-utils");var tabUtils=_interopRequireWildcard(_tabUtils);var _settingsStorage=require("./settings-storage");var settings=_interopRequireWildcard(_settingsStorage);var _openPages=require("./open-pages");var pages=_interopRequireWildcard(_openPages);var _logger=require("./logger");var log=_interopRequireWildcard(_logger);function _getRequireWildcardCache(){if(typeof WeakMap!=="function")return null;var cache=new WeakMap();_getRequireWildcardCache=function(){return cache;};return cache;}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj};}var cache=_getRequireWildcardCache();if(cache&&cache.has(obj)){return cache.get(obj);}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}newObj.default=obj;if(cache){cache.set(obj,newObj);}return newObj;}log.info('Chrome Avgle Helper background script started!');log.info(`Extension id: ${chrome.runtime.id}`);global['__avgle_helper_context']={queryTabStorage,downloadVideoFile,modules:{tabUtils,settings,log,pages}};const{tabStorage}=tabUtils;const bashTemplate=new _bashTemplate.BashTemplate(chrome.extension.getURL('dist/downloader.sh'));const bashTemplate4hls=new _bashTemplate.BashTemplate(chrome.extension.getURL('dist/downloader-hls.sh'));const getBashTemplateUpdateAt=tmpl=>tmpl.matchString(/UPDATE_AT=['"](\S+)['"]/,1);bashTemplate.init(()=>log.info(`Loaded bash template (update at: ${getBashTemplateUpdateAt(bashTemplate)})`));bashTemplate4hls.init(()=>log.info(`Loaded bash template for hls.js (update at: ${getBashTemplateUpdateAt(bashTemplate4hls)})`));settings.storage.init();tabStorage.init();registerLoggerConnectForConsolePage();registerDownloadCommandMessageListener();chrome.webRequest.onBeforeRequest.addListener(details=>{if(details.tabId<0)return;log.info([`Captured m3u8 request`,`  tabId: ${details.tabId}`,`  ${details.method} ${details.url}`].join('\n'));chrome.tabs.get(details.tabId,tab=>{if(!tab)return log.error(`Cannot find tab with id ${details.tabId}`);log.info(`Tab title: ${tab.title}`);log.info(`Tab URL: ${tab.url}`);const matchedPage=_config.VIDEO_PAGE_PATTERN.find(it=>it.pattern.test(tab.url));if(!matchedPage)return log.info(`Ignore: URL of tab is not matched in VIDEO_PAGE_PATTERN`);const pageType=matchedPage.type;const m3u8URL=details.url;const m3u8URLBase64=btoa(m3u8URL);const matchedProcesser=_config.PROCESSABLE_M3U8_PATTERN.find(it=>it.pattern.test(m3u8URL));if(!matchedProcesser)return log.info(`Ignore: URL of m3u8 request is not matched with any pattern in PROCESSABLE_M3U8_PATTERN`);const context={m3u8URL,m3u8URLBase64,tabURL:tab.url,pageType,needDecode:matchedProcesser.base64Encoded,extensionId:chrome.runtime.id,security:(0,_messageSecurity.getSecurityCode)()};tabStorage.update(tab.id,context);if(tab.active)setBrowserAction(true);injectScript(null,context);function injectScript(error,parameters={}){if(error){if(typeof error!='string')error='message'in error?`${error.message}\n${error.stack}`:String(error);parameters.error=error;}let code='';if(parameters.pageType==='avgle')code=(0,_mainPlayerPageHls.getInjectScript)(parameters);else code=(0,_mainPlayerPage.getInjectScript)(parameters);chrome.tabs.executeScript(details.tabId,{code},()=>{log.info('Inject script success!');});}});},{urls:_config.M3U8_PATTERN_ARRAY});tabUtils.addOnTabFocusChangedListener(tab=>setBrowserAction(tab?queryTabStorage(tab.id).carNumber:false));function registerLoggerConnectForConsolePage(){chrome.runtime.onConnect.addListener(port=>{if(port.name!="console"){log.error(`unknown connection with name: ${port.name}`);return port.disconnect();}log.info('log connection established','muted');log.bindLogCallback(log=>port.postMessage(log));port.postMessage(log.getLogHistoryHTML());port.onMessage.addListener(msg=>{if(msg=='clear-log'){log.clearLogHistory();log.info('log cleared','muted');return;}});port.onDisconnect.addListener(()=>{log.unbindLogCallback();log.info('log connection disconnected','muted');});});}function registerDownloadCommandMessageListener(){chrome.runtime.onMessage.addListener((message,sender,response)=>{if(!checkMessage(message,sender,false))return;onMessage(message,sender.tab.id);});chrome.runtime.onMessageExternal.addListener((message,sender,response)=>{if(!checkMessage(message,sender))return console.error('Invalid message');onMessage(message,sender.tab.id);});function checkMessage(message,sender,checkCode=true){if(!message||!sender||!sender.tab||!sender.tab.id)return false;if(checkCode&&!(0,_messageSecurity.testMessageSecurityCode)(message.code))return false;return true;}function onMessage(message,tabId){if(message.log)return log.info(message.log);if(message.logError)return log.error(message.logError);if(message.carNumber){log.info(`Video name: ${message.carNumber}`);tabStorage.update(tabId,{carNumber:message.carNumber,wait:message.wait});return;}if(message.segments){log.info(`Segment Count: ${message.segments.length}`);tabStorage.update(tabId,{segments:message.segments});return;}}}function queryTabStorage(tabId){return tabStorage.get(tabId);}function setBrowserAction(detectedVideo){chrome.browserAction.setIcon({path:chrome.extension.getURL(detectedVideo?'icons/128.png':'icons/128-disabled.png')});}function downloadVideoFile(tabInfo,type='downloader'){if(!tabInfo)return;if(typeof tabInfo.carNumber==='undefined')return;let downloaderType='normal';if(typeof tabInfo.segments!=='undefined'){downloaderType='hls';}else if(tabInfo.wait==='segments'){return alert(`Wait a moment, extension has not received video segments info.`);}else if(['m3u8URLBase64','pageType'].find(it=>typeof tabInfo[it]==='undefined')){return;}settings.storage.get().then(settingValues=>{console.log(settingValues);const context={CFG_RANDOM_ID:(0,_uuid.uuid)(),CFG_VIDEO_NAME:tabInfo.carNumber,CFG_M3U8_URL:tabInfo.m3u8URL,CFG_DECODE_M3U8:tabInfo.needDecode?'true':'false',CFG_PAGE_TYPE:tabInfo.pageType,CFG_MAX_CONCURRENT_DL:settingValues.concurrentDownloads||'5',CFG_USER_AGENT:navigator.userAgent,CFG_PROXY:settingValues.proxy||'',CFG_DELETE_TMP_FILES:normalizeYesNoAsk(settingValues.deleteTempFiles),CFG_DELETE_DOWNLOADER:normalizeYesNoAsk(settingValues.deleteDownloader)};if(downloaderType==='hls'){Object.assign(context,{CFG_SEGMENTS:tabInfo.segments.join('\n'),CFG_SEGMENT_COUNT:tabInfo.segments.length});if(type==='segment-list')return downloadList(context);}if(type==='downloader')downloadDownloader(context);});function downloadList(context){const filename=`list-${tabInfo.carNumber}.txt`;const blob=new Blob([context.CFG_SEGMENTS],{type:'text/plain'});const url=URL.createObjectURL(blob);chrome.downloads.download({url,saveAs:true,filename});}function downloadDownloader(context){const filename=`download-${tabInfo.carNumber}.sh`;const bash=(downloaderType==='hls'?bashTemplate4hls:bashTemplate).compile(context);const blob=new Blob([bash],{type:'text/x-shellscript'});const url=URL.createObjectURL(blob);chrome.downloads.download({url,saveAs:true,filename});}function normalizeYesNoAsk(value){if(/^(yes|true)$/i.test(value))return'yes';if(/^(no|false)$/i.test(value))return'no';return'ask';}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"../config":10,"../inject/main-player-page":12,"../inject/main-player-page-hls":11,"./bash-template":1,"./logger":3,"./message-security":4,"./open-pages":5,"./settings-storage":7,"./tab-utils":8,"./uuid":9}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.bindLogCallback=bindLogCallback;exports.unbindLogCallback=unbindLogCallback;exports.info=info;exports.error=error;exports.clearLogHistory=clearLogHistory;exports.getLogHistoryHTML=getLogHistoryHTML;exports.getErrorLogItems=getErrorLogItems;const MAX_HISTORY=1000;const AVG_HISTORY=700;let history=[];let logCallback=undefined;function push2history(content,type="info"){let ctx={t:Date.now(),c:content,type};if(history.length>=MAX_HISTORY)history=history.slice(MAX_HISTORY-AVG_HISTORY);history.push(ctx);if(logCallback)logCallback(logItem2html(ctx));return ctx;}let escapeMap={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;',' ':'&nbsp'};let escape=text=>text.replace(/[&<>"'`=/ ]/g,matched=>escapeMap[matched]);function bindLogCallback(callback){logCallback=callback;}function unbindLogCallback(){logCallback=undefined;}function logItem2html(item){let d=new Date(item.t);let part=item.c.split(/(https?:\/\/\S+)/).map(ctx=>ctx.match(/^https?:\/\//)?`<a href="${encodeURI(ctx)}" target="_blank">${escape(decodeURI(ctx))}</a>`:escape(ctx).replace(/\n/g,'<br />'));return`<div class="item">
		<div class="prefix">${escape(d.toLocaleDateString()+" "+d.toLocaleTimeString())}</div>
		<div class="${item.type}">
			${part.join('')}
		</div>
	</div>`;}function info(content,type="info"){console.log(content);push2history(content,type);}function error(content){console.error(content);push2history(content,"error");}function clearLogHistory(){history=[];}function getLogHistoryHTML(){return history.map(logItem2html).join('\n');}function getErrorLogItems(){return history.filter(it=>it.type==='error');}},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.refreshMessageSecurityCode=refreshMessageSecurityCode;exports.getSecurityCode=getSecurityCode;exports.testMessageSecurityCode=testMessageSecurityCode;let securityCode='';const characters='abcdefghijklmnopqrstuvwxyz1234567890';const charactersLen=characters.length;function refreshMessageSecurityCode(){let code='';for(let i=0;i<16;i++)code+=characters.charAt(Math.floor(Math.random()*charactersLen));securityCode=code;}function getSecurityCode(){if(!securityCode)refreshMessageSecurityCode();return securityCode;}function testMessageSecurityCode(code){return securityCode&&code===securityCode;}},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.openConsolePage=openConsolePage;exports.openSettingsPage=openSettingsPage;exports.openHelpPage=openHelpPage;exports.openExtensionInternalURI=openExtensionInternalURI;function openConsolePage(){openExtensionInternalURI('dist/console/index.html',{active:false}).then(tab=>{chrome.windows.create({tabId:tab.id,type:'popup',focused:true,width:800,height:400},win=>{});});}function openSettingsPage(){openExtensionInternalURI(`dist/settings/index.html`);}function openHelpPage(){openExtensionInternalURI(`dist/help/index.html`);}function openExtensionInternalURI(uri,options){const url=chrome.extension.getURL(uri);return new Promise(resolve=>{chrome.tabs.query({url},tabs=>{if(tabs.length>0){const tab=tabs[0];chrome.tabs.update(tab.id,{active:true},resolve);return;}chrome.tabs.create(Object.assign({url},options||{}),resolve);});});}},{}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getSystemInfo=getSystemInfo;let infoCache=null;function getSystemInfo(callback){if(infoCache)return callback(infoCache);Promise.all([getPlatformInfo(),getLanguageInfo()]).then(results=>{const[info,languages]=results;let isWin=true;if(info&&!/win/i.test(info.os))isWin=false;let is64bit=false;if(info&&/64/.test(info.arch)||/64/.test(info.nacl_arch))is64bit=true;let defaultLanguage='en';if(languages&&languages[0]){const lang=String(languages[0]).toLowerCase();if(lang==='zh'){defaultLanguage='zh-Hans';}else if(lang.indexOf('zh-')>=0){defaultLanguage=/-(?:tw|hk|hant)/.test(lang)?'zh-Hant':'zh-Hans';}}infoCache={isWin,is64bit,defaultLanguage};callback(infoCache);});}function getLanguageInfo(){return new Promise(resolve=>{chrome.i18n.getAcceptLanguages(resolve);});}function getPlatformInfo(){return new Promise(resolve=>{chrome.runtime.getPlatformInfo(resolve);});}},{}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.storage=exports.settingKeyNameSet=exports.settingKeyNames=exports.settingDefaultValues=undefined;exports.getDefaultSettings=getDefaultSettings;var _os=require("./os");var os=_interopRequireWildcard(_os);var _logger=require("./logger");var log=_interopRequireWildcard(_logger);function _getRequireWildcardCache(){if(typeof WeakMap!=="function")return null;var cache=new WeakMap();_getRequireWildcardCache=function(){return cache;};return cache;}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj};}var cache=_getRequireWildcardCache();if(cache&&cache.has(obj)){return cache.get(obj);}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}newObj.default=obj;if(cache){cache.set(obj,newObj);}return newObj;}const settingDefaultValues=exports.settingDefaultValues={language:()=>new Promise(resolve=>os.getSystemInfo(info=>resolve(info.defaultLanguage))),concurrentDownloads:'5',deleteTempFiles:'ask',deleteDownloader:'ask',proxy:''};const settingKeyNames=exports.settingKeyNames=Object.keys(settingDefaultValues);const settingKeyNameSet=exports.settingKeyNameSet=new Set(settingKeyNames);class SettingsStorage{constructor(){this._settings=null;}init(){return this.get(true);}get(reload=false){if(!reload&&this._settings)return Promise.resolve(this._settings);return Promise.all([getDefaultSettings(),new Promise(resolve=>chrome.storage.sync.get(settingKeyNames,resolve))]).then(args=>{const[defaultSettings,settings]=args;const fullSettings=Object.assign({},defaultSettings,settings);this._settings=fullSettings;console.log(fullSettings);return fullSettings;}).catch(error=>{log.error(`Load settings from chrome.storage.sync failed: ${error.message||error}`);return{};});}save(newSettings){const validKeys=Object.keys(newSettings).filter(it=>settingKeyNameSet.has(it)).filter(it=>it!=='language');const update={};for(const key of validKeys){const value=newSettings[key];if(value===this._settings[key])continue;update[key]=value;}if(!Object.keys(update).length)return Promise.resolve([]);return new Promise(resolve=>{chrome.storage.sync.set(update,()=>{if(chrome.runtime.lastError){log.error('Save settings to chrome.storage.sync failed: '+chrome.runtime.lastError.message);}this.init().then(()=>resolve(Object.keys(update)));});});}}const storage=exports.storage=new SettingsStorage();function getDefaultSettings(){const result={};let thenable=Promise.resolve(true);settingKeyNames.forEach(key=>{let value=settingDefaultValues[key];if(typeof value==='function')value=value();if(value&&typeof value.then==='function')thenable=thenable.then(()=>value).then(realValue=>result[key]=realValue);else result[key]=value;});return thenable.then(()=>result);}},{"./logger":3,"./os":6}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.addOnTabFocusChangedListener=addOnTabFocusChangedListener;function addOnTabFocusChangedListener(listener){chrome.tabs.onActivated.addListener(info=>{chrome.tabs.get(info.tabId,tab=>listener(tab));});chrome.windows.onFocusChanged.addListener(windowId=>{chrome.tabs.query({active:true,windowId},tabs=>{listener(tabs.length>0?tabs[0]:null);});});}class TabStorage{constructor(){this.map=new Map();}init(){if(this.init)return;this.init=true;chrome.tabs.onRemoved.addListener(tabId=>this.delete(tabId));}delete(tabId){this.map.delete(tabId);}get(tabId){return this.map.get(tabId)||{};}update(tabId,object){const oldObject=this.map.get(tabId);object=Object.assign(oldObject||{},object);this.map.set(tabId,object);}}const tabStorage=exports.tabStorage=new TabStorage();},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});let hasCryptoModule=typeof crypto!=='undefined'&&typeof crypto.getRandomValues==='function';const uuid=exports.uuid=hasCryptoModule?crypto_getRandomValues:math_random;function math_random(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c=='x'?r:r&0x3|0x8;return v.toString(16);});}function crypto_getRandomValues(){return String([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));}},{}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const M3U8_PATTERN_ARRAY=exports.M3U8_PATTERN_ARRAY=['*://*/*.m3u8','*://*/*.m3u8?*','*://gooqlevideo.xyz/playback/*'];const PROCESSABLE_M3U8_PATTERN=exports.PROCESSABLE_M3U8_PATTERN=[{pattern:/\.\w+cdn\.com\//},{pattern:/\.cdn\.qooqlevideo\.com\//},{pattern:/\/playback\//,base64Encoded:true},{pattern:/\w+\.xvideos-cdn\.com/}];const VIDEO_PAGE_PATTERN=exports.VIDEO_PAGE_PATTERN=[{pattern:/^(https|http):\/\/avgle.com\/video\/\w+/,type:'avgle'},{pattern:/^(https|http):\/\/(?:www\.)xvideos.com\/video\w+/,type:'xvideos'}];},{}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getInjectScript=getInjectScript;var _utils=require("./utils");var _utils2=_interopRequireDefault(_utils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function getInjectScript(paramters){const injectHelperName='chromeAvgleHelper';const coreCode=`
		(function core() {
			${_utils2.default.getInjectUtilsScript(injectHelperName)};
			(${main.toString()})(${injectHelperName},${JSON.stringify(paramters)});
		})();
	`;const wrapCode=`
		const s = document.createElement('script');
		s.textContent = ${JSON.stringify(coreCode)};
		document.documentElement.appendChild(s);
		document.documentElement.removeChild(s);
	`;return wrapCode;}function main(utils,parameters={}){waitForVideoJS(100,()=>{const player=videojs('video-player');player.on('loadedmetadata',()=>{logInfo(`Detected the hls.js loadedmetadata event!`);const arr=[];try{const segments=player.tech_.hls.playlists.media_.segments;segments.forEach(x=>arr.push({uri:x.resolvedUri}));arr.forEach(videojs.Hls.xhr.beforeRequest);arr.forEach(x=>typeof x.decryptURI==='function'&&x.decryptURI());}catch(error){return logError(error);}if(arr.length<=0)return logError(`Invalid hls.js segments: length <= 0`);const invalidItemIndex=arr.findIndex(x=>!x.uri);if(invalidItemIndex>=0)return logError(`Invalid hls.js segments: segments[${invalidItemIndex}] doesn't have 'uri'`);const uris=arr.map(x=>x.uri);sendMessage({segments:uris});});});const{$,el}=utils;const classes={commandBox:'chrome-avgle-extension-inject-box',videoNumberTag:'chrome-avgle-extension-player-car-number'};const videoTitleDOM=$('.container .row .col-lg-12 h1');const pageType='avgle';let tipTitle='Download This Video:';let command='';let videoNumber=getDefaultCarNumber();const info=getVideoInfo();if(info&&info.number){videoNumber=utils.buildVideoFullName({videoNumber:info.number,episode:info.episode});const{insertPoint}=info;utils.removeElement($(`.${classes.videoNumberTag}`,insertPoint.parentNode));insertPoint.parentNode.insertBefore(createCarNumberElement(videoNumber),insertPoint);}command='Click the "Download Video" item in the extension popup menu';if(pageType==='avgle'){const videoColumn=$('.video-container').parentNode.parentNode;videoColumn.className="col-lg-12 col-md-12 col-sm-12";}const injectContainer=getInjectContainer();if(injectContainer){const injectBox=el('div',{display:'flex',flexDirection:'column',color:'#282828',backgroundColor:'#f7f7f7',border:'1px solid #ccc',borderRadius:'4px'},{class:classes.commandBox},[el('div',{padding:'5px 0 0 10px',fontSize:'15px',color:'#888'},null,tipTitle),el('pre',{padding:'5px 15px 9px 15px',margin:'0',fontSize:'13px',lineHeight:'1.5',wordBreak:'break-all',wordWrap:'break-word',border:'none'},null,el('code',{padding:0,fontSize:'13px',color:'#222222',backgroundColor:'transparent',whiteSpace:'pre-wrap'},null,command))]);injectContainer.appendChild(injectBox);}sendMessage({carNumber:videoNumber,wait:'segments'});return;function getInjectContainer(){let injectContainer;if(pageType==='avgle'){injectContainer=videoTitleDOM.parentNode.parentNode;}else if(pageType==='xvideos'){injectContainer=$('.video-metadata.video-tags-list');}if(injectContainer)utils.removeElement($(`.${classes.commandBox}`,injectContainer));return injectContainer;}function getDefaultCarNumber(){const tabURL=String(location.href||'');if(pageType==='avgle'){const avgleId=tabURL.match(/\/video\/(\w+)\//);return`avgle-${avgleId?avgleId[1]:'unknown'}`;}if(pageType==='xvideos'){const videoId=tabURL.match(/\/(video\w+)\//);return`xvideos-${videoId?videoId[1]:'unknown'}`;}return'unknown';}function createCarNumberElement(carNumber){return el('b',{color:'#77b300',margin:'0 0.5em',fontSize:'18px'},{class:classes.videoNumberTag},carNumber);}function getVideoInfo(){if(!videoTitleDOM)return;let title='',episode='',number='',insertPoint,hasOtherEpisodes=false;const nodes=Array.from(videoTitleDOM.childNodes);for(let i=0;i<nodes.length;i++){const node=nodes[i];if(!title&&node.nodeType===Node.TEXT_NODE){title=String(node.textContent||'').trim();number=utils.parseCarNumber(title);insertPoint=node;const mtx=title.match(/^[\s\S]+-\s+(\d+)$/);if(mtx&&mtx[1])episode=mtx[1];continue;}if(node.nodeType===Node.ELEMENT_NODE){if(node.tagName==='A'&&title){hasOtherEpisodes=true;continue;}}}if(!hasOtherEpisodes)episode='';return{title,number,episode,insertPoint};}function waitForVideoJS(timeout,callback){if(typeof videojs!=='function'){if(timeout<=0)return console.log('videojs is undefined!');return setTimeout(waitForVideoJS.bind(this,timeout-1,callback),100);}callback();}function sendMessage(message){chrome.runtime.sendMessage(parameters.extensionId,Object.assign(message,{code:parameters.security}));}function logInfo(log){console.log(`Avgle Helper:`,log);sendMessage({log});}function logError(log){console.error(`Avgle Helper:`,log);sendMessage({logError});}}},{"./utils":13}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getInjectScript=getInjectScript;var _utils=require("./utils");var _utils2=_interopRequireDefault(_utils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function getInjectScript(paramters){const injectHelperName='chromeAvgleHelper';return`
		${_utils2.default.getInjectUtilsScript(injectHelperName)};
		(${main.toString()})(
			${injectHelperName},
			${JSON.stringify(paramters)}
		);`;}function main(utils,parameters={}){const{$,el}=utils;const classes={commandBox:'chrome-avgle-extension-inject-box',videoNumberTag:'chrome-avgle-extension-player-car-number'};const pageType=parameters.pageType;const tabURL=String(parameters.tabURL||'');const m3u8URLBase64=String(parameters.m3u8URLBase64||'');const videoTitleDOM=$('.container .row .col-lg-12 h1');let tipTitle='Download Commands:';if(pageType==='avgle')tipTitle='Avgle Download Commands:';else if(pageType==='xvideos')tipTitle='XVIDEOS Download Commands:';let command='';let videoNumber=getDefaultCarNumber();let downloaderOpts=[];const info=getVideoInfo(pageType);if(info&&info.number){videoNumber=utils.buildVideoFullName({videoNumber:info.number,episode:info.episode});const{insertPoint}=info;utils.removeElement($(`.${classes.videoNumberTag}`,insertPoint.parentNode));insertPoint.parentNode.insertBefore(createCarNumberElement(videoNumber),insertPoint);}if(pageType==='xvideos')downloaderOpts.push('type=xvideos');if(parameters.needDecode)downloaderOpts.push('decode=true');downloaderOpts.push(`name=${videoNumber}`);downloaderOpts.push(`url=${m3u8URLBase64}`);command=[`AvgleDownloader ${downloaderOpts.join(' ')};`,`Avgle ${videoNumber}; # combine video files`].join('\n');if(pageType==='avgle'){const videoColumn=$('.video-container').parentNode.parentNode;videoColumn.className="col-lg-12 col-md-12 col-sm-12";}const injectContainer=getInjectContainer();if(injectContainer){const injectBox=el('div',{display:'flex',flexDirection:'column',color:'#282828',backgroundColor:'#f7f7f7',border:'1px solid #ccc',borderRadius:'4px'},{class:classes.commandBox},[el('div',{padding:'5px 0 0 10px',fontSize:'15px',color:'#888'},null,tipTitle),el('pre',{padding:'5px 15px 9px 15px',margin:'0',fontSize:'13px',lineHeight:'1.5',wordBreak:'break-all',wordWrap:'break-word',border:'none'},null,el('code',{padding:0,fontSize:'13px',color:'#222222',backgroundColor:'transparent',whiteSpace:'pre-wrap'},null,command))]);injectContainer.appendChild(injectBox);}chrome.runtime.sendMessage({carNumber:videoNumber});return;function getInjectContainer(){let injectContainer;if(pageType==='avgle'){injectContainer=videoTitleDOM.parentNode.parentNode;}else if(pageType==='xvideos'){injectContainer=$('.video-metadata.video-tags-list');}if(injectContainer)utils.removeElement($(`.${classes.commandBox}`,injectContainer));return injectContainer;}function getDefaultCarNumber(){if(pageType==='avgle'){const avgleId=tabURL.match(/\/video\/(\w+)\//);return`avgle-${avgleId?avgleId[1]:'unknown'}`;}if(pageType==='xvideos'){const videoId=tabURL.match(/\/(video\w+)\//);return`xvideos-${videoId?videoId[1]:'unknown'}`;}return'unknown';}function createCarNumberElement(carNumber){return el('b',{color:'#77b300',margin:'0 0.5em',fontSize:'18px'},{class:classes.videoNumberTag},carNumber);}function getVideoInfo(pageType){if(!videoTitleDOM)return;let title='',episode='',number='',insertPoint,hasOtherEpisodes=false;const nodes=Array.from(videoTitleDOM.childNodes);for(let i=0;i<nodes.length;i++){const node=nodes[i];if(!title&&node.nodeType===Node.TEXT_NODE){title=String(node.textContent||'').trim();number=utils.parseCarNumber(title);insertPoint=node;const mtx=title.match(/^[\s\S]+-\s+(\d+)$/);if(mtx&&mtx[1])episode=mtx[1];continue;}if(node.nodeType===Node.ELEMENT_NODE){if(node.tagName==='A'&&title){hasOtherEpisodes=true;continue;}}}if(!hasOtherEpisodes)episode='';return{title,number,episode,insertPoint};}}},{"./utils":13}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const utilsFunctions={getInjectUtilsScript,el,$,$$,escapeHTML,removeElement,parseCarNumber,buildVideoFullName};exports.default=utilsFunctions;function getInjectUtilsScript(globalVariableName,useWindowScope=true){let result=`${useWindowScope?'window.':'const '}${globalVariableName} = {};`;result+=Object.keys(utilsFunctions).filter(funcName=>funcName!=='getInjectUtilsScript').map(funcName=>{const funcBody=utilsFunctions[funcName].toString();return`${globalVariableName}.${funcName} = (${funcBody});`;}).join('');return result;}function el(tageName,style,attrs,children){const element=document.createElement(tageName);if(style)Object.keys(style).forEach(key=>element.style[key]=style[key]);if(attrs)Object.keys(attrs).forEach(key=>element.setAttribute(key,attrs[key]));if(children){if(Array.isArray(children))children.forEach(child=>element.append(child));else element.append(children);}return element;}function $(selector,element){return(element||document).querySelector(selector);}function $$(selector,element){return Array.from((element||document).querySelectorAll(selector)||[]);}function removeElement(element){if(element&&element.parentNode)element.parentNode.removeChild(element);}function escapeHTML(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}function parseCarNumber(str=''){const matchers=[[/C2[\s\-.]Lab.+(?:(\d+)[\s\-.])?([a-z]+)[\s\-.](\d+)/i,match=>`C2Lab-${match[1]?`${match[1]}-`:''}${match[2]}-${match[3]}`],[/Tokyo[-\s]+Hot[-\s]+(\w{4,6})/i,match=>`Tokyo-Hot-${match[1]}`],[/AXDVD[-\s+](\d{3,5}\w)/i,match=>`AXDVD-${match[1]}`],[/LOVE[-\s](\d{3,4})/i,match=>`LOVE-${match[1]}`],[/10musume[-_\s](\d{6})[-_\s](\d{2})/i,match=>`10musume-${match[1]}-${match[2]}`],[/fc2[\s\-_]?ppv[\s\-_]?(\d+)/i,match=>`FC2-PPV-${match[1]}`],[/S-Cute\s+(\w+)\s+#(\d+)/i,match=>`S-Cute-${match[1]}-${match[2]}`],[/Heydouga[-_\s]?(\d+)[-_\s]?(\d+)/i,match=>`Heydouga-${match[1]}-${match[2]}`],[/heyzo[-_\s]?(\d+)/i,match=>`heyzo-${match[1]}`],[/(\d+)[-_\s](\d+)[-_\s]Carib(?:bean(?:com)?)?/i,match=>`carib-${match[1]}-${match[2]}`],[/Carib(?:bean(?:com)?)?[-_\s]?(\d+)[-_\s]?(\d+)/i,match=>`carib-${match[1]}-${match[2]}`],[/(?:kbj|korean).+bj(20\d+)/i,match=>`Korean-BJ-${match[1]}`],/\w+-\d+/i,[/(\w{8,})[-_\s](\d{5,})[-_\s](\d{3,})/,match=>`${match[1]}-${match[2]}-${match[3]}`]];for(let matcher of matchers){if(Array.isArray(matcher)){let result=str.match(matcher[0]);if(result)return matcher[1](result);}else{let result=str.match(matcher);if(result)return result[0];}}return null;}function buildVideoFullName(input,expression='${videoNumber}.ep${episode_123}'){if(!input.episode)return input.videoNumber;let ep=parseInt(input.episode,10)||1;let epabc='',epABC='';while(ep>0){const charCode=String.fromCharCode(65-1+ep%26);epABC=String.fromCharCode(charCode)+epABC;epabc=String.fromCharCode(charCode+32)+epabc;ep=Math.floor(ep/26);}return expression.replace(/\$\{\s*([\w-$]+)\s*\}/g,(_,varName)=>{let mtx=varName.match(/^ep(?:isode)?_?(123|abc)?/i);if(mtx){const type=mtx[1];if(!type||type==='123')return input.episode;if(type==='ABC')return epABC;return epabc;}mtx=varName.match(/^(video_?|name|number)/i);if(mtx)return input.videoNumber;return varName;});}},{}]},{},[2]);
//# sourceMappingURL=index.js.map